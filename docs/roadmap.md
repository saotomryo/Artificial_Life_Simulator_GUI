# 進化促進アップデート計画（群知識・生存戦略の「見える化」重視）

本ロードマップは、人工生命シミュレーションに新たな適応圧を追加するだけでなく、  
**「群知識（collective knowledge）」や「生存戦略」が発生したことを観測・再現しやすい順番**で拡張することを目的とします。

方針:
- まず **観測基盤（見える化）** を整備して、戦略の発生/変化を定量で追える状態にする
- 次に **戦略プリミティブ（行動/記憶）** を拡張して、分化が起きる自由度を与える
- その後 **共有情報チャネル（フェロモン/通信など）** を入れて、群知識が外在化しやすい条件を作る

---

## Stage 0: 観測・可視化（最優先）
「戦略が生まれた/変わった」を GUI とログで判断できる状態を作る。

- **フレーム拡張（追跡可能化）**
  - `frame["agents"]` に `id`（個体ID）を追加
  - `parent_id`（親ID）、`birth_tick`、`age` を追加（系譜と世代追跡）
  - 可能なら `strategy_tag`（後述の自動ラベル）も付与
- **イベント計測（原因と結果を分離）**
  - `eat`（フードtype別）、`attack`（試行/成功）、`mate`（試行/成立）、`fission`（成立）をカウント
  - 死亡原因の内訳（餓死/危険/攻撃/その他）を集計
- **分布・比率の可視化**
  - 出力行動（`thrust/turn/attack/mate/eat_strength`）の分布/比率（直近 N tick）
  - 集団指標: 密度（近傍数）、移動距離、ホームレンジ、群れ（クラスタ）サイズ分布
- **環境オーバーレイ**
  - hazard フィールドをワールドビュー上に半透明表示
  - フード密度フィールド（σ）をヒートマップ表示（任意）
  - 季節係数（現在の `season_multiplier`）を表示
- **エクスポート**
  - 既存 CSV/録画 JSON に、上記の集計指標を追加して A/B 比較可能にする

> ✅ 完了条件:
> - 「戦略の兆候（例: 攻撃率、分裂率、食性、群れサイズ、死亡原因）」が GUI と CSV で確認できる

---

## Stage 1: 動的環境とリスクフィールド（実装済み）
現状コードに実装済みのため、ここは **ベースラインとして固定**し、Stage 0/1/2 の検証に使う。

- **季節サイクル**（`season_period`, `season_amplitude`）
- **危険ゾーンフィールド**（`hazard_strength`, `hazard_coverage`）
- **フード密度フィールド**（`food_density_variation`）
- **UI（環境タブ）**: GUI から編集/保存/読み込みが可能

> ✅ 完了条件:
> - GUI から調整でき、餌量・危険ダメージの変化が実行中に確認できる

---

## Stage 2: 戦略プリミティブ（行動・記憶）の拡張
個体レベルで戦略差が出る自由度を増やし、「分化」が起きやすい土台を作る。

- **行動出力の追加**
  - `ダッシュ`: vmax↑、コスト↑
  - `防御`: 被ダメ軽減（危険/攻撃）、代謝↑
  - `休息`: 代謝↓（ただし機会損失）
- **短期メモリ入力（おすすめ）**
  - 直近の `ΔE`、直近行動、危険遭遇回数などの EMA（指数移動平均）を入力に追加
  - 「環境に応じたスイッチング」が学習されやすくなる
- **UI/設定**
  - 追加出力の ON/OFF とコスト係数を GUI から調整
  - ライブ統計に行動比率（直近 N tick）と分布を表示

> ✅ 完了条件:
> - 行動比率が個体群内で分化し、季節/危険パラメータ変更に追随して分布がシフトする

---

## Stage 3: 群知識（collective knowledge）を生む情報チャネル
個体の内部だけでなく、**環境・集団に知識が外在化**する仕組みを追加する。

- **フェロモン/マーカー場（stigmergy）**
  - 個体が場にスカラー（またはベクトル）を「置く」、他個体が「読む」
  - 拡散・減衰・最大値クリップを持つ低解像度グリッドで管理
- **通信（近傍集約）**
  - 出力に `signal` を追加し、近傍個体の信号平均/分散を入力へ
- **集団情報入力**
  - 近傍密度、近傍の平均速度、近傍の「行動量（攻撃/分裂の活性）」など
- **可視化（Stage 0 とセット）**
  - フェロモン場のヒートマップ/等高線を表示
  - 群れの移動（トレイル）を録画に残す

> ✅ 完了条件:
> - フード密度をドリフトさせたとき、フェロモン帯や群れ移動が再現性をもって現れ、ログ指標で検出できる

---

## Stage 4: 戦略の自動ラベリングと A/B 比較実験
「それっぽい」ではなく、定量で戦略を分類し、条件の違いで分布が変わることを示す。

- **自動ラベル（ルールベースから開始）**
  - Predator: 攻撃成功が多い
  - Forager: フード摂食が多い（type別も）
  - Scavenger: 死体依存が高い
  - Fissioner: 分裂比率が高い
  - Nomad/Resident: 移動距離・ホームレンジで分類
- **比較設計**
  - 同一シードでパラメータを 1 つだけ変える A/B を標準化
  - 指標の差分（ラベル分布、死亡原因、群れサイズ、資源利用）を CSV で出力

> ✅ 完了条件:
> - プリセット/設定差に応じて戦略ラベル分布が安定して変化し、再現実験ができる

---

## Stage 5: 形質とトレードオフ（戦略の固定化）
戦略が一時的な行動だけでなく、**遺伝形質のトレードオフ**として表出するようにする。

- **体質パラメータ追加**
  - `HP`（耐久）、`弾性`（ダメージ軽減率）、`代謝タイプ`（省エネ〜高燃費）
  - サイズと組み合わせて、速度・視野・代謝・被ダメージなどを算出
- **遺伝処理**
  - `Genome` に形質用の数値遺伝子（別枠）を追加し、交叉・変異で継承
- **UI/表示**
  - 形質の分布（ヒストグラム/平均・分散）と、戦略ラベルとの相関を表示

> ✅ 完了条件:
> - 形質の違いが寿命/繁殖成功/戦略ラベルに明確に影響し、GUI から調整できる

---

## Stage 6: センサー拡張（戦略の精緻化）
戦略の多様性と適応速度を上げる入力拡張。

- **入力チャンネル**
  - フード/死体専用レイ（混雑センサと分離）
  - 危険濃度センサ、フェロモン値、短期履歴ベクトル
  - 近傍個体の活動度（攻撃/分裂/通信）集約
- **設定**
  - GUI で ON/OFF、レイ数、範囲、履歴長を指定

> ✅ 完了条件:
> - 行動多様性/適応速度が向上し、Stage 4 の指標（戦略分布）がより分化する

---

## Stage 7: 多様性維持と評価指標（長期安定化）
長期実行で収束しにくくし、複数戦略が共存できるようにする。

- **ニッチシェアリング**
  - 行動/形質/群れ特徴の類似度で過密を抑制
- **寿命・老化**
  - 最大寿命、加齢で代謝↑/移動↓など
- **新奇性メトリクス**
  - 珍しい行動/群れパターンに弱いボーナス（可視化とセット）
- **評価可視化**
  - 平均寿命、出生/死亡率、新奇性、形質分布、戦略ラベル分布の時系列

> ✅ 完了条件:
> - 長期実行でも多様性が維持され、戦略が単一に収束しにくい

---

## Stage 8: プリセット／シナリオ（再現性パッケージ化）
「群知識/戦略が見える」条件をワンクリックで再現できるようにする。

- **プリセット例**
  - 砂漠: 低フード・高危険 → 省エネ/Resident が有利
  - 湿地: 高フード・危険パッチ → 群れ探索/フェロモンが有利
  - 季節: 強い周期変動 → スイッチング戦略が有利
- **GUI**
  - プリセット読込 + シナリオ概要 + 観測ポイント（指標）を表示
- **ドキュメント**
  - README に「観測の仕方」「見える指標」「再現手順」を記載

> ✅ 完了条件:
> - プリセットからすぐに特徴的な戦略/群知識が再現でき、観測指標もセットで提示される

---

## 実装補足
- **性能**: 場（hazard/フェロモン等）は低解像度（8〜64 グリッド）で保持し、参照は O(1)。
- **A/B 比較**: 追加項目は GUI から ON/OFF・強度調整できる設計にして比較を容易にする。
- **ログ設計**: 「見える化の指標」は録画 JSON/CSV に必ず残し、再解析できる形にする。
